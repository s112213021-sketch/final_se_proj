<!-- templates/view_upload.html -->
{% extends "base.html" %}
{% block title %}æª¢è¦–æª”æ¡ˆ{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <h5>ğŸ‘ï¸ æª”æ¡ˆæª¢è¦–</h5>
            <a href="/dashboard" class="btn btn-secondary btn-sm">ğŸ  è¿”å›</a>
        </div>
        <div class="card-body">
            <p><strong>ğŸ¡ å°ˆæ¡ˆï¼š</strong> {{ bid.project_title }}</p>
            <p><strong>ğŸ§‘â€ğŸ’¼ æ‰¿åŒ…å•†ï¼š</strong> {{ bid.contractor_name }}</p>
            <p><strong>ğŸ’° å ±åƒ¹ï¼š</strong> ${{ "%.2f"|format(bid.price) }}</p>

            <hr>

            <!-- ========= ç‰ˆæœ¬æ­·å²å€å¡Š ========= -->
            {% if versions and versions|length > 0 %}
            <h6 class="mb-3">ğŸ“¦ äº¤ä»˜ç‰©ç‰ˆæœ¬æ­·å²</h6>
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th width="100">ç‰ˆæœ¬</th>
                            <th>æª”æ¡ˆåç¨±</th>
                            <th width="180">ä¸Šå‚³æ™‚é–“</th>
                            <th width="100">ç‹€æ…‹</th>
                            <th width="120">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in versions %}
                        <tr {% if v.is_active %}class="table-success"{% endif %}>
                            <td>
                                <span class="badge {% if v.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                    v{{ v.version_number }}
                                </span>
                            </td>
                            <td>
                                {{ v.original_filename }}
                                {% if v.is_active %}
                                <span class="badge bg-warning text-dark ms-2">æœ€æ–°</span>
                                {% endif %}
                            </td>
                            <td class="text-muted small">
                                {{ v.created_at.strftime('%Y-%m-%d %H:%M') if v.created_at else 'â€”' }}
                            </td>
                            <td>
                                {% if v.is_active %}
                                <span class="text-success">âœ“ ç•¶å‰ç‰ˆæœ¬</span>
                                {% else %}
                                <span class="text-muted">æ­·å²ç‰ˆæœ¬</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/uploads/{{ v.stored_filename }}"
                                   class="btn btn-outline-primary btn-sm"
                                   target="_blank"
                                   download="{{ v.original_filename }}">
                                    ğŸ“¥ ä¸‹è¼‰
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- ========= èˆŠç‰ˆå‘å¾Œå…¼å®¹ ========= -->
            {% elif upload %}
            <h6 class="mb-3">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</h6>
            <p><strong>æª”æ¡ˆï¼š</strong>
                <a href="/uploads/{{ upload.filename }}" target="_blank" class="text-primary">
                    {{ upload.filename }} (é»æ“Šä¸‹è¼‰)
                </a>
            </p>
            <p><strong>â° ä¸Šå‚³æ™‚é–“ï¼š</strong> {{ upload.created_at }}</p>
            {% else %}
            <div class="alert alert-warning">
                âš ï¸ å°šæœªä¸Šå‚³ä»»ä½•æª”æ¡ˆ
            </div>
            {% endif %}

            <hr>

            <!-- ========= Issue Tracker æ•´åˆ ========= -->
            <div class="mb-3">
                {% set pid = project_id if project_id is defined else bid.project_id %}
                <a href="/issues/{{ pid }}" class="btn btn-outline-primary btn-sm">
                    ğŸ“ æå‡ºå•é¡Œ / æŸ¥çœ‹ Issues
                    {% if open_issues is defined and open_issues > 0 %}
                        <span class="badge bg-danger ms-1">{{ open_issues }}</span>
                    {% endif %}
                </a>
            </div>

            <!-- ========= æ“ä½œæŒ‰éˆ• ========= -->
            {% if user.role == "client" and bid.project_status != 'completed' %}
            <div class="d-flex gap-2 mb-3">
                <form method="post" action="/reject_bid/{{ bid.id }}" class="d-inline">
                    <button type="submit" class="btn btn-warning btn-sm"
                            onclick="return confirm('ç¢ºå®šè¦é€€ä»¶å—ï¼Ÿæ‰¿åŒ…å•†éœ€é‡æ–°ä¸Šå‚³ã€‚')">
                        ğŸ”„ é€€ä»¶ï¼ˆè¦æ±‚ä¿®æ”¹ï¼‰
                    </button>
                </form>

                <!-- âœ… çµæ¡ˆï¼šåªæœ‰ open_issues == 0 æ‰èƒ½çµæ¡ˆ -->
                {% if open_issues is defined %}
                    {% if open_issues == 0 %}
                    <form method="post" action="/projects/{{ bid.project_id }}/complete_if_no_open_issues" class="d-inline">
                        <button type="submit" class="btn btn-success btn-sm"
                                onclick="return confirm('ç¢ºå®šé©—æ”¶é€šéä¸¦çµæ¡ˆå—ï¼Ÿ')">
                            âœ… é©—æ”¶é€šéï¼ˆçµæ¡ˆï¼‰
                        </button>
                    </form>
                    {% else %}
                    <button class="btn btn-success btn-sm" disabled title="å°šæœ‰ {{ open_issues }} å€‹ Issue æœªå®Œæˆ">
                        âœ… çµæ¡ˆï¼ˆå°šæœ‰ {{ open_issues }} å€‹ Issueï¼‰
                    </button>
                    {% endif %}
                {% else %}
                <!-- Fallback: å¦‚æœæ²’æœ‰ open_issues æ•¸æ“šï¼Œä½¿ç”¨åŸæœ¬çš„çµæ¡ˆé‚è¼¯ -->
                <form method="post" action="/complete_project/{{ bid.project_id }}" class="d-inline">
                    <button type="submit" class="btn btn-success btn-sm"
                            onclick="return confirm('ç¢ºå®šé©—æ”¶é€šéä¸¦çµæ¡ˆå—ï¼Ÿ')">
                        âœ… é©—æ”¶é€šéï¼ˆçµæ¡ˆï¼‰
                    </button>
                </form>
                {% endif %}
            </div>

            {% if open_issues is defined and open_issues > 0 %}
            <div class="alert alert-warning">
                âš ï¸ ç›®å‰å°šæœ‰ <strong>{{ open_issues }}</strong> å€‹ Issue æœªå®Œæˆï¼Œè«‹å…ˆå…¨éƒ¨è™•ç†å®Œæˆå†çµæ¡ˆã€‚
            </div>
            {% endif %}

            {% elif user.role == "contractor" %}
            {% if bid.project_status == 'completed' %}
            <div class="alert alert-success">
                ğŸ‰ <strong>å·²çµæ¡ˆï¼Œå¯©æ ¸é€šéï¼æ­å–œå®Œæˆä»»å‹™ï¼</strong>
            </div>
            {% elif bid.status == 'rejected' %}
            <div class="alert alert-warning mb-3">
                âš ï¸ <strong>æª”æ¡ˆå·²è¢«é€€ä»¶ï¼Œè«‹ä¾ Issue/ç•™è¨€è¦æ±‚ä¿®æ­£å¾Œé‡æ–°ä¸Šå‚³</strong>
            </div>
            <a href="/upload/{{ bid.project_id }}" class="btn btn-primary btn-sm">
                ğŸ”„ ä¸Šå‚³æ–°ç‰ˆæœ¬
            </a>
            {% else %}
            <div class="alert alert-info">
                â³ <strong>æª”æ¡ˆå·²æäº¤ï¼Œç­‰å¾…å¯©æ ¸ä¸­...</strong>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
