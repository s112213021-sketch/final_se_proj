{% extends "base.html" %}
{% block title %}å§”è¨—äººå„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-4">æˆ‘çš„å°ˆæ¡ˆ</h1>
    <a href="/create_project" class="btn btn-success btn-sm mb-4">æ–°å¢å°ˆæ¡ˆ</a>

    {% if session.get("flash_message") %}
    <div class="alert alert-{{ session.flash_type or 'info' }} alert-dismissible fade show">
        {{ session.flash_message | safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert">Ã—</button>
    </div>
    {% endif %}

    {% if projects %}
    {% for p in projects %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ p.title }}</h5>
            <span class="badge bg-{{
                'warning' if p.status == 'completed'
                else 'success' if p.status == 'in_progress'
                else 'info' if p.status == 'submitted'
                else 'secondary'
            }}">
                {{ p.status | replace('_', ' ') | title }}
            </span>
        </div>
        <div class="card-body">
            <p class="mb-2">{{ p.description }}</p>
            <p class="text-muted small mb-3">
                <strong>é ç®—</strong> ${{ p.budget }} |
                <strong>æˆªæ­¢</strong> {{ p.deadline }}
            </p>

            {% if p.bids is defined and p.bids|length > 0 %}
            <hr class="my-3">
            <h6 class="mb-3">æ”¶åˆ°çš„å ±åƒ¹ ({{ p.bids|length }})</h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover align-middle">
                    <thead>
                        <tr>
                            <th>å ±åƒ¹äºº</th>
                            <th>é‡‘é¡</th>
                            <th>ç‹€æ…‹</th>
                            <th>ä¸Šå‚³æª”æ¡ˆ</th>
                            <th width="200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bid in p.bids %}
                        <tr>
                            <td>
                                <div class="d-flex flex-column">
                                    <strong>{{ bid.contractor_name }}</strong>
                                    <div class="mt-1">
                                        {% if bid.review_count > 0 %}
                                            <a href="/reputation/{{ bid.contractor_id }}?role=contractor" 
                                               class="badge bg-warning text-dark text-decoration-none border border-warning"
                                               title="æŸ¥çœ‹ä¹™æ–¹è©•åƒ¹è©³æƒ…">
                                               â˜… {{ "%.1f"|format(bid.avg_rating) }} ({{ bid.review_count }})
                                            </a>
                                        {% else %}
                                            <span class="badge bg-light text-muted border">å°šç„¡è©•åƒ¹</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            
                            <td class="text-success fw-bold">${{ "%.2f"|format(bid.price) }}</td>
                            <td>
                                {% if bid.status == 'accepted' %}
                                <span class="badge bg-success">å·²æ¥å—</span>
                                {% elif bid.status == 'rejected' %}
                                <span class="badge bg-danger">å·²é€€ä»¶</span>
                                {% elif bid.status == 'completed' %}
                                <span class="badge bg-warning">å·²çµæ¡ˆ</span>
                                {% else %}
                                <span class="badge bg-secondary">å¾…å¯©æ ¸</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if bid.can_view %}
                                    {% if p.status == 'completed' %}
                                    <span class="badge bg-warning text-dark">çµæ¡ˆå­˜æª”</span>
                                    {% else %}
                                    <span class="badge bg-success">å·²ä¸Šå‚³</span>
                                    {% endif %}
                                {% elif bid.status == 'rejected' %}
                                <span class="text-muted">â€”</span>
                                {% else %}
                                <span class="text-muted">å°šæœªä¸Šå‚³</span>
                                {% endif %}
                            </td>
                            <td>
                                <!-- ä¸‹è¼‰ææ¡ˆ PDF -->
                                <div class="mb-2">
                                    <a href="/download_proposal/{{ bid.id }}"
                                       class="btn btn-outline-primary btn-sm w-100"
                                       title="ä¸‹è¼‰ææ¡ˆè¨ˆç•«æ›¸">
                                        ğŸ“„ ä¸‹è¼‰ææ¡ˆ
                                    </a>
                                </div>

                                <!-- é¸æ“‡æ‰¿åŒ…å•† -->
                                {% if p.status == 'open' and bid.status == 'pending' %}
                                <div class="mb-2">
                                    <form method="post" action="/accept_bid/{{ bid.id }}">
                                        <button type="submit"
                                                class="btn btn-success btn-sm w-100"
                                                onclick="return confirm('ç¢ºå®šè¦é¸æ“‡æ­¤æ‰¿åŒ…å•†å—ï¼Ÿé¸æ“‡å¾Œå…¶ä»–æŠ•æ¨™å°‡è¢«æ‹’çµ•ã€‚')">
                                            âœ… é¸æ“‡æ­¤æ‰¿åŒ…å•†
                                        </button>
                                    </form>
                                </div>
                                {% endif %}

                                <!-- æª¢è¦–äº¤ä»˜æª”æ¡ˆ -->
                                {% if bid.can_view %}
                                    {% if p.status == 'completed' %}
                                    <div>
                                        <a href="/view_upload/{{ bid.id }}" class="btn btn-info btn-sm w-100">ğŸ“‚ æª¢è¦–çµæ¡ˆæª”</a>
                                    </div>
                                    {% elif bid.status != 'rejected' %}
                                    <div>
                                        <a href="/view_upload/{{ bid.id }}" class="btn btn-info btn-sm w-100">ğŸ“‚ æª¢è¦–æª”æ¡ˆ</a>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">å°šæœªæ”¶åˆ°å ±åƒ¹</p>
            {% endif %}

            {% if p.status == 'open' %}
            <div class="mt-3">
                <a href="/edit_project/{{ p.id }}" class="btn btn-warning btn-sm">ç·¨è¼¯å°ˆæ¡ˆ</a>
            </div>
            {% endif %}

            {% if p.status == 'completed' %}
                <div class="mt-3 border-top pt-3">
                    {% if not p.has_reviewed %}
                        <span class="text-success me-2">âœ… å°ˆæ¡ˆå·²çµæ¡ˆ</span>
                        <a href="/review/{{ p.id }}" class="btn btn-primary btn-sm">â­ è©•åƒ¹æ¥æ¡ˆè€…</a>
                    {% else %}
                        <span class="text-success me-2">âœ… å°ˆæ¡ˆå·²çµæ¡ˆ</span>
                        <button class="btn btn-secondary btn-sm" disabled>å·²è©•åƒ¹</button>
                    {% endif %}
                </div>
            {% endif %}

        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info">
        å°šæœªå»ºç«‹å°ˆæ¡ˆï¼Œ<a href="/create_project" class="alert-link">é»æ­¤æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹å°ˆæ¡ˆ</a>
    </div>
    {% endif %}
</div>
{% endblock %}