<!-- templates/contractor_dashboard.html -->
<!-- 承包商（接案者）的儀表板頁面 -->
<!-- 主要功能：
1. 顯示可接案的專案列表
2. 顯示已報價的專案狀態
3. 管理已承接的專案
4. 上傳專案成果
-->

{% extends "base.html" %}
{% block title %}承包商儀表板{% endblock %}

{% block content %}
<div class="container">
    <!-- 顯示用戶歡迎訊息 -->
    <h1 class="mt-4">歡迎，{{ request.session.user.username }}！</h1>

    <!-- 顯示系統提示訊息（如操作成功/失敗提示） -->
    {% if session.get("flash_message") %}
    <div class="alert alert-{{ session.flash_type or 'info' }} alert-dismissible fade show">
        {{ session.flash_message | safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <hr>

    <!-- 可報價專案 -->
    <section class="mb-5">
        <h3>可報價的專案</h3>
        {% if projects %}
        <div class="row">
            {% for p in projects %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5>{{ p.title }}</h5>
                        <p>{{ p.description[:100] }}...</p>
                        <p><strong>預算：</strong> ${{ p.budget }}</p>
                        <a href="/submit_bid/{{ p.id }}" class="btn btn-primary btn-sm">提交報價</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">目前沒有開放專案</p>
        {% endif %}
    </section>

    <hr>

    <!-- 我的報價 -->
    <section>
        <h3>我的報價</h3>
        {% if bids %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>專案</th>
                    <th>金額</th>
                    <th>狀態</th>
                    <th>檔案</th>
                </tr>
            </thead>
            <tbody>
                {% for bid in bids %}
                <tr>
                    <!-- 專案名稱 -->
                    <td>{{ bid.project_title }}</td>

                    <!-- 金額 -->
                    <td>${{ "%.2f"|format(bid.price) }}</td>

                    <!-- 狀態欄 -->
                    <td>
                        {% if bid.status == 'accepted' and bid.upload_filename %}
                        <span class="badge bg-success">已上傳</span>
                        {% elif bid.status == 'accepted' %}
                        <span class="badge bg-warning text-dark">待上傳</span>
                        {% elif bid.status == 'rejected' %}
                        <span class="badge bg-danger">已退件</span>
                        {% else %}
                        <span class="badge bg-light text-dark">待審核</span>
                        {% endif %}
                    </td>

                    <!-- 檔案欄 -->
                    <td>
                        {% if bid.status == 'accepted' and bid.upload_filename %}
                        <a href="/view_upload/{{ bid.id }}" class="btn btn-info btn-sm">
                            已上傳（檢視）
                        </a>
                        {% elif bid.status == 'accepted' %}
                        <a href="/upload/{{ bid.project_id }}" class="btn btn-success btn-sm">
                            上傳檔案
                        </a>
                        {% else %}
                        <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">尚未提交報價</p>
        {% endif %}
    </section>
</div>
{% endblock %}